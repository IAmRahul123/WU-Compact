workflows:
  android-release-minor:
    name: Android Build & Firebase Distribution
    max_build_duration: 45
    triggering:
      events: [push, tag]
      branch_patterns:
        - pattern: release
    environment:
      vars:
        FIREBASE_APP_ID: $FIREBASE_APP_ID
      groups:
        - Firebase # Should contain FIREBASE_SERVICE_ACCOUNT securely

    scripts:
      - name: Set Yarn Classic
        script: yarn set version classic

      - name: Install Dependencies
        script: yarn install --no-immutable

      - name: Run Unit Tests
        script: yarn test || echo "Skipping tests"

      - name: Bump Minor Version
        script: |
          MAJOR=1
          MINOR=$(( BUILD_NUMBER ))
          echo "VERSION_CODE=$BUILD_NUMBER" >> $CM_ENV
          echo "VERSION_NAME=$MAJOR.$MINOR" >> $CM_ENV
          echo "âœ… Bumped version to $MAJOR.$MINOR"

      - name: Make gradlew executable
        script: chmod +x android/gradlew

      - name: Build Release APK
        script: |
          cd android
          ./gradlew assembleRelease \
            -PversionCode=$VERSION_CODE \
            -PversionName=$VERSION_NAME

      - name: Install Firebase CLI
        script: curl -sL https://firebase.tools | bash

      - name: Set Firebase Credentials
        script: |
          echo $FIREBASE_SERVICE_ACCOUNT > ${CM_BUILD_DIR}/firebase_service_account.json
          export GOOGLE_APPLICATION_CREDENTIALS=${CM_BUILD_DIR}/firebase_service_account.json

      - name: Distribute via Firebase
        script: |
          firebase appdistribution:distribute \
            android/app/build/outputs/apk/release/app-release.apk \
            --app $FIREBASE_APP_ID \
            --groups "qa" \
            --release-notes "Branch: $CM_BRANCH\nCommit: $CM_COMMIT"

artifacts:
  - android/app/build/outputs/**/*.apk
